

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>obstools.atacr.classes &mdash; Home 0.2.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=37f418d5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Home
              <img src="../../../_static/obstools_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quick Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../links.html">GitHub Repositories</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../links.html#references">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../obstools.html">Licence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../obstools.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../obstools.html#using-local-data">Using local data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../atacr.html">ATaCR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../comply.html">Comply</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Home</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">obstools.atacr.classes</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for obstools.atacr.classes</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 Pascal Audet &amp; Helen Janiszewski</span>
<span class="c1">#</span>
<span class="c1"># This file is part of OBStools.</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="c1"># in the Software without restriction, including without limitation the rights</span>
<span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
<span class="c1"># furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be included in</span>
<span class="c1"># all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="c1"># SOFTWARE.</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">stft</span><span class="p">,</span> <span class="n">detrend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">Trace</span><span class="p">,</span> <span class="n">read</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obstools.atacr</span><span class="w"> </span><span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">plotting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pkg_resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">resource_filename</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="c1"># np.set_printoptions(threshold=sys.maxsize)</span>


<div class="viewcode-block" id="Power">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.Power">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Power</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for power spectra for each component, with any shape</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    c11 : :class:`~numpy.ndarray`</span>
<span class="sd">        Power spectral density for component 1 (any shape)</span>
<span class="sd">    c22 : :class:`~numpy.ndarray`</span>
<span class="sd">        Power spectral density for component 2 (any shape)</span>
<span class="sd">    cZZ : :class:`~numpy.ndarray`</span>
<span class="sd">        Power spectral density for component Z (any shape)</span>
<span class="sd">    cPP : :class:`~numpy.ndarray`</span>
<span class="sd">        Power spectral density for component P (any shape)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c11</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c22</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cZZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cPP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c11</span> <span class="o">=</span> <span class="n">c11</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c22</span> <span class="o">=</span> <span class="n">c22</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span> <span class="o">=</span> <span class="n">cZZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span> <span class="o">=</span> <span class="n">cPP</span></div>



<div class="viewcode-block" id="Cross">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.Cross">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Cross</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for cross-power spectra for each component pairs, with any shape</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    c12 : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components 1 and 2 (any shape)</span>
<span class="sd">    c1Z : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components 1 and Z (any shape)</span>
<span class="sd">    c1P : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components 1 and P (any shape)</span>
<span class="sd">    c2Z : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components 2 and Z (any shape)</span>
<span class="sd">    c2P : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components 2 and P (any shape)</span>
<span class="sd">    cZP : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components Z and P (any shape)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c12</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c1Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c1P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c2Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">c2P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cZP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c12</span> <span class="o">=</span> <span class="n">c12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span> <span class="o">=</span> <span class="n">c1Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1P</span> <span class="o">=</span> <span class="n">c1P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span> <span class="o">=</span> <span class="n">c2Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2P</span> <span class="o">=</span> <span class="n">c2P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span> <span class="o">=</span> <span class="n">cZP</span></div>



<div class="viewcode-block" id="Rotation">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.Rotation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Rotation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for rotated spectra, with any shape</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    cHH : :class:`~numpy.ndarray`</span>
<span class="sd">        Power spectral density for rotated horizontal component H (any shape)</span>
<span class="sd">    cHZ : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components H and Z (any shape)</span>
<span class="sd">    cHP : :class:`~numpy.ndarray`</span>
<span class="sd">        Cross-power spectral density for components H and P (any shape)</span>
<span class="sd">    coh : :class:`~numpy.ndarray`</span>
<span class="sd">        Coherence between horizontal components</span>
<span class="sd">    ph : :class:`~numpy.ndarray`</span>
<span class="sd">        Phase of cross-power spectrum between horizontal components</span>
<span class="sd">    tilt : float</span>
<span class="sd">        Angle (azimuth) of tilt axis</span>
<span class="sd">    coh_value : float</span>
<span class="sd">        Maximum coherence</span>
<span class="sd">    phase_value : float</span>
<span class="sd">        Phase at maximum coherence</span>
<span class="sd">    phi : :class:`~numpy.ndarray`</span>
<span class="sd">        Directions for which the coherence is calculated</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cHH</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cHZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cHP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coh_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cHH</span> <span class="o">=</span> <span class="n">cHH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span> <span class="o">=</span> <span class="n">cHZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHP</span> <span class="o">=</span> <span class="n">cHP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coh</span> <span class="o">=</span> <span class="n">coh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph</span> <span class="o">=</span> <span class="n">ph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="n">tilt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coh_value</span> <span class="o">=</span> <span class="n">coh_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_value</span> <span class="o">=</span> <span class="n">phase_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span></div>



<div class="viewcode-block" id="DayNoise">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.DayNoise">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DayNoise</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A DayNoise object contains attributes that associate</span>
<span class="sd">    three-component raw (or deconvolved) traces, metadata information</span>
<span class="sd">    and window parameters. The available methods carry out the quality</span>
<span class="sd">    control steps and the average daily spectra for windows flagged as</span>
<span class="sd">    &quot;good&quot;.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The object is initialized with :class:`~obspy.core.Trace` objects for</span>
<span class="sd">    H1, H2, HZ and P components. Traces can be empty if data are not</span>
<span class="sd">    available. Upon saving, those traces are discarded to save disk space.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    tr1, tr2, trZ, trP : :class:`~obspy.core.Trace` object</span>
<span class="sd">        Corresponding trace objects for components H1, H2, HZ and HP. </span>
<span class="sd">        Traces can be empty (i.e., ``Trace()``) for missing components.</span>
<span class="sd">    window : float</span>
<span class="sd">        Length of time window in seconds</span>
<span class="sd">    overlap : float</span>
<span class="sd">        Fraction of overlap between adjacent windows</span>
<span class="sd">    key : str</span>
<span class="sd">        Station key for current object</span>
<span class="sd">    dt : float</span>
<span class="sd">        Sampling distance in seconds. Obtained from ``trZ`` object</span>
<span class="sd">    npts : int</span>
<span class="sd">        Number of points in time series. Obtained from ``trZ`` object</span>
<span class="sd">    fs : float</span>
<span class="sd">        Sampling frequency (in Hz). Obtained from ``trZ`` object</span>
<span class="sd">    year : str</span>
<span class="sd">        Year for current object (obtained from UTCDateTime). Obtained from</span>
<span class="sd">        ``trZ`` object</span>
<span class="sd">    julday : str</span>
<span class="sd">        Julian day for current object (obtained from UTCDateTime). Obtained</span>
<span class="sd">        from ``trZ`` object</span>
<span class="sd">    ncomp : int</span>
<span class="sd">        Number of available components (either 2, 3 or 4). Obtained from</span>
<span class="sd">        non-empty ``Trace`` objects</span>
<span class="sd">    tf_list : Dict</span>
<span class="sd">        Dictionary of possible transfer functions given the available</span>
<span class="sd">        components.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Get demo noise data as DayNoise object</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import DayNoise</span>
<span class="sd">    &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo data - March 04, 2012, station 7D.M08A</span>

<span class="sd">    Now check its main attributes</span>

<span class="sd">    &gt;&gt;&gt; print(*[daynoise.tr1, daynoise.tr2, daynoise.trZ, daynoise.trP], sep=&quot;\n&quot;)</span>
<span class="sd">    7D.M08A..BH1 | 2012-03-04T00:00:00.000000Z - 2012-03-04T23:59:59.800000Z | 5.0 Hz, 432000 samples</span>
<span class="sd">    7D.M08A..BH2 | 2012-03-04T00:00:00.000000Z - 2012-03-04T23:59:59.800000Z | 5.0 Hz, 432000 samples</span>
<span class="sd">    7D.M08A..BHZ | 2012-03-04T00:00:00.000000Z - 2012-03-04T23:59:59.800000Z | 5.0 Hz, 432000 samples</span>
<span class="sd">    7D.M08A..BDH | 2012-03-04T00:00:00.000000Z - 2012-03-04T23:59:59.800000Z | 5.0 Hz, 432000 samples    </span>
<span class="sd">    &gt;&gt;&gt; daynoise.window</span>
<span class="sd">    7200.0</span>
<span class="sd">    &gt;&gt;&gt; daynoise.overlap</span>
<span class="sd">    0.3</span>
<span class="sd">    &gt;&gt;&gt; daynoise.key</span>
<span class="sd">    &#39;7D.M08A&#39;</span>
<span class="sd">    &gt;&gt;&gt; daynoise.ncomp</span>
<span class="sd">    4</span>
<span class="sd">    &gt;&gt;&gt; daynoise.tf_list</span>
<span class="sd">    {&#39;ZP&#39;: True, &#39;Z1&#39;: True, &#39;Z2-1&#39;: True, &#39;ZP-21&#39;: True, &#39;ZH&#39;: True, &#39;ZP-H&#39;: True}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tr2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mf">7200.</span><span class="p">,</span>
                 <span class="n">overlap</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="c1"># Load example data if initializing empty object</span>
        <span class="k">if</span> <span class="n">tr1</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span> <span class="ow">or</span> <span class="n">tr1</span> <span class="o">==</span> <span class="s1">&#39;Demo&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uploading demo data - March 04, 2012, station 7D.M08A&quot;</span><span class="p">)</span>
            <span class="n">exmpl_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;obstools&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">))</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">exmpl_path</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span> <span class="o">/</span> <span class="s1">&#39;2012.064*.SAC&#39;</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trZ</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trP</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mf">7200.</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;7D.M08A&#39;</span>

        <span class="c1"># Check that all traces are valid Trace objects</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">trZ</span><span class="p">,</span> <span class="n">trP</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">Trace</span><span class="p">):</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error initializing DayNoise object - &quot;</span>
                                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; is not a Trace object&quot;</span><span class="p">))</span>

        <span class="c1"># Unpack everything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr1</span> <span class="o">=</span> <span class="n">tr1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr2</span> <span class="o">=</span> <span class="n">tr2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trZ</span> <span class="o">=</span> <span class="n">trZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trP</span> <span class="o">=</span> <span class="n">trP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

        <span class="c1"># Get trace attributes</span>
        <span class="n">zstats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trZ</span><span class="o">.</span><span class="n">stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">npts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">sampling_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">julday</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">julday</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">julday</span><span class="p">)</span>

        <span class="c1"># Get number of components for the available, non-empty traces</span>
        <span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span>
             <span class="n">Stream</span><span class="p">(</span><span class="n">traces</span><span class="o">=</span><span class="p">[</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">trZ</span><span class="p">,</span> <span class="n">trP</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="n">ncomp</span>

        <span class="c1"># Build list of available transfer functions based on the number of</span>
        <span class="c1"># components</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">QC</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DayNoise.QC_daily_spectra">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.DayNoise.QC_daily_spectra">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">QC_daily_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pd</span><span class="o">=</span><span class="p">[</span><span class="mf">0.004</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                         <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fig_QC</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to determine daily time windows for which the spectra are</span>
<span class="sd">        anomalous and should be discarded in the calculation of the</span>
<span class="sd">        transfer functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pd : list</span>
<span class="sd">            Frequency corners of passband for calculating the spectra</span>
<span class="sd">        tol : float</span>
<span class="sd">            Tolerance threshold. If spectrum &gt; std*tol, window is flagged as</span>
<span class="sd">            bad</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Confidence interval for f-test</span>
<span class="sd">        smooth : boolean</span>
<span class="sd">            Determines if the smoothed (True) or raw (False) spectra are used</span>
<span class="sd">        fig_QC : boolean</span>
<span class="sd">            Whether or not to produce a figure showing the results of the</span>
<span class="sd">            quality control</span>
<span class="sd">        debug : boolean</span>
<span class="sd">            Whether or not to plot intermediate steps in the QC procedure</span>
<span class="sd">            for debugging</span>
<span class="sd">        save : :class:`~pathlib.Path` object</span>
<span class="sd">            Relative path to figures folder</span>
<span class="sd">        form : str</span>
<span class="sd">            File format (e.g., &#39;png&#39;, &#39;jpg&#39;, &#39;eps&#39;)</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        ftX : :class:`~numpy.ndarray`</span>
<span class="sd">            Windowed Fourier transform for the `X` component (can be either</span>
<span class="sd">            1, 2, Z or P)</span>
<span class="sd">        f : :class:`~numpy.ndarray`</span>
<span class="sd">            Full frequency axis (Hz)</span>
<span class="sd">        goodwins : list</span>
<span class="sd">            List of booleans representing whether a window is good (True)</span>
<span class="sd">            or not (False)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Perform QC on DayNoise object using default values and plot final</span>
<span class="sd">        figure</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import DayNoise</span>
<span class="sd">        &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; daynoise.QC_daily_spectra(fig_QC=True)</span>

<span class="sd">        .. figure:: ../obstools/examples/figures/Figure_3a.png</span>
<span class="sd">           :align: center</span>

<span class="sd">        Print out new attribute of DayNoise object</span>

<span class="sd">        &gt;&gt;&gt; daynoise.goodwins</span>
<span class="sd">        array([False,  True,  True,  True,  True,  True,  True,  True, False,</span>
<span class="sd">           False,  True,  True,  True,  True,  True,  True], dtype=bool)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Points in window</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Number of points to overlap</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">overlap</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># hanning window</span>
        <span class="n">hanning</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ss</span><span class="p">)</span>
        <span class="n">wind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
        <span class="n">wind</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">hanning</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ss</span><span class="p">]</span>
        <span class="n">wind</span><span class="p">[</span><span class="o">-</span><span class="n">ss</span><span class="p">:</span><span class="n">ws</span><span class="p">]</span> <span class="o">=</span> <span class="n">hanning</span><span class="p">[</span><span class="n">ss</span><span class="p">:</span><span class="n">ws</span><span class="p">]</span>

        <span class="c1"># Get windowed Fourier transforms</span>
        <span class="n">ft1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ft2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ftZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ftP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Calculate windowed FFTs and store as transpose</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ftZ</span> <span class="o">=</span> <span class="n">stft</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trZ</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">return_onesided</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">padded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">wind</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span>
            <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">ftZ</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">*</span> <span class="n">ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span> <span class="o">=</span> <span class="n">ftZ</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">_f</span><span class="p">,</span> <span class="n">_t</span><span class="p">,</span> <span class="n">ftP</span> <span class="o">=</span> <span class="n">stft</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trP</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">return_onesided</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">padded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">wind</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span>
                <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">ftP</span> <span class="o">=</span> <span class="n">ftP</span> <span class="o">*</span> <span class="n">ws</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span> <span class="o">=</span> <span class="n">ftP</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">_f</span><span class="p">,</span> <span class="n">_t</span><span class="p">,</span> <span class="n">ft1</span> <span class="o">=</span> <span class="n">stft</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tr1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">return_onesided</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">padded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">wind</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span>
                <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">_f</span><span class="p">,</span> <span class="n">_t</span><span class="p">,</span> <span class="n">ft2</span> <span class="o">=</span> <span class="n">stft</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tr2</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">return_onesided</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">padded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">wind</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span>
                <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">ft1</span> <span class="o">=</span> <span class="n">ft1</span> <span class="o">*</span> <span class="n">ws</span>
            <span class="n">ft2</span> <span class="o">=</span> <span class="n">ft2</span> <span class="o">*</span> <span class="n">ws</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span> <span class="o">=</span> <span class="n">ft1</span><span class="o">.</span><span class="n">T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span> <span class="o">=</span> <span class="n">ft2</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Store frequency axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>

        <span class="c1"># Get spectrograms for single day-long keys</span>
        <span class="n">psd1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">psd2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">psdZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">psdP</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Positive frequencies for PSD plots</span>
        <span class="n">faxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">faxis</span><span class="p">]</span>

        <span class="n">psdZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ftZ</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">2.</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">psdZ</span> <span class="o">=</span> <span class="n">psdZ</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">faxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">psdP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ftP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">psdP</span> <span class="o">=</span> <span class="n">psdP</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">faxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">psd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ft1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">psd1</span> <span class="o">=</span> <span class="n">psd1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">faxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">psd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ft2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="n">psd2</span> <span class="o">=</span> <span class="n">psd2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">faxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="n">fig_QC</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdZ</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdP</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Seconds&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">+</span> \
                        <span class="s1">&#39;.specgram_Z.P.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd1</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd2</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdZ</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Seconds&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">+</span> \
                        <span class="s1">&#39;.specgram_H1.H2.Z.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd1</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd2</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdZ</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdP</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Seconds&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">+</span> \
                        <span class="s1">&#39;.specgram_H1.H2.Z.P.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Select bandpass frequencies</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([(</span><span class="n">psd</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">for</span> <span class="n">psd</span> <span class="ow">in</span>
                   <span class="p">[</span><span class="n">psd1</span><span class="p">,</span> <span class="n">psd2</span><span class="p">,</span> <span class="n">psdZ</span><span class="p">,</span> <span class="n">psdP</span><span class="p">]</span> <span class="k">if</span> <span class="n">psd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">smooth</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="c1"># Smooth out the log of the PSDs</span>
            <span class="n">sl_psd1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psd2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psdZ</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psdP</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psdZ</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdZ</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">psdZ</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sl_psdP</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdP</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">psdP</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sl_psd1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">psd1</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">sl_psd2</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">psd2</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Take the log of the PSDs</span>
            <span class="n">sl_psd1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psd2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psdZ</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psdP</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sl_psdZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdZ</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sl_psdP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psdP</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">sl_psd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd1</span><span class="p">)</span>
                <span class="n">sl_psd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psd2</span><span class="p">)</span>

        <span class="c1"># Remove mean of the log PSDs</span>
        <span class="n">dsl_psdZ</span> <span class="o">=</span> <span class="n">sl_psdZ</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psdZ</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dsl_psdP</span> <span class="o">=</span> <span class="n">sl_psdP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psdP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsl_psdZ</span><span class="p">,</span> <span class="n">dsl_psdP</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dsl_psd1</span> <span class="o">=</span> <span class="n">sl_psd1</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psd1</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsl_psd2</span> <span class="o">=</span> <span class="n">sl_psd2</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psd2</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsl_psd1</span><span class="p">,</span> <span class="n">dsl_psd2</span><span class="p">,</span> <span class="n">dsl_psdZ</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dsl_psd1</span> <span class="o">=</span> <span class="n">sl_psd1</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psd1</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsl_psd2</span> <span class="o">=</span> <span class="n">sl_psd2</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psd2</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsl_psdP</span> <span class="o">=</span> <span class="n">sl_psdP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_psdP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsl_psd1</span><span class="p">,</span> <span class="n">dsl_psd2</span><span class="p">,</span> <span class="n">dsl_psdZ</span><span class="p">,</span> <span class="n">dsl_psdP</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psdZ</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psdP</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psd1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psd2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psdZ</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psd1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psd2</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psdZ</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sl_psdP</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Cycle through to kill high-std-norm windows</span>
        <span class="n">moveon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">goodwins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="kc">True</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">indwin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">goodwins</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">moveon</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

            <span class="n">ubernorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">goodwins</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ind_u</span><span class="p">,</span> <span class="n">dsl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsls</span><span class="p">):</span>
                <span class="n">normvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">goodwins</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indwin</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">indwin</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
                    <span class="n">normvar</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dsl</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">ubernorm</span><span class="p">[</span><span class="n">ind_u</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">normvar</span><span class="p">)</span> <span class="o">-</span> <span class="n">normvar</span>

            <span class="n">penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ubernorm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">goodwins</span><span class="p">)),</span> <span class="n">detrend</span><span class="p">(</span>
                    <span class="n">ubernorm</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">goodwins</span><span class="p">)),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ubernorm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

            <span class="n">kill</span> <span class="o">=</span> <span class="n">penalty</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">penalty</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kill</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span> <span class="o">=</span> <span class="n">goodwins</span>
                <span class="n">moveon</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">trypenalty</span> <span class="o">=</span> <span class="n">penalty</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">kill</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">ftest</span><span class="p">(</span><span class="n">penalty</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trypenalty</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="n">goodwins</span><span class="p">[</span><span class="n">indwin</span><span class="p">[</span><span class="n">kill</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">indwin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">goodwins</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">moveon</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">moveon</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span> <span class="o">=</span> <span class="n">goodwins</span>

        <span class="k">if</span> <span class="n">fig_QC</span><span class="p">:</span>
            <span class="n">power</span> <span class="o">=</span> <span class="n">Power</span><span class="p">(</span><span class="n">sl_psd1</span><span class="p">,</span> <span class="n">sl_psd2</span><span class="p">,</span> <span class="n">sl_psdZ</span><span class="p">,</span> <span class="n">sl_psdP</span><span class="p">)</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">fig_QC</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">goodwins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

            <span class="c1"># Save or show figure</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;QC.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">QC</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="DayNoise.average_daily_spectra">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.DayNoise.average_daily_spectra">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">average_daily_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_rotation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tiltfreqs</span><span class="o">=</span><span class="p">[</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.035</span><span class="p">],</span>
                              <span class="n">fig_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fig_coh_ph</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">form</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to average the daily spectra for good windows. By default, the</span>
<span class="sd">        method will attempt to calculate the azimuth of maximum coherence</span>
<span class="sd">        between horizontal components and the vertical component (for maximum</span>
<span class="sd">        tilt direction), and use the rotated horizontals in the transfer</span>
<span class="sd">        function calculations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calc_rotation : boolean</span>
<span class="sd">            Whether or not to calculate the tilt direction</span>
<span class="sd">        tiltfreqs : list</span>
<span class="sd">            Two floats representing the frequency band at which the tilt is</span>
<span class="sd">            calculated</span>
<span class="sd">        fig_average : boolean</span>
<span class="sd">            Whether or not to produce a figure showing the average daily</span>
<span class="sd">            spectra</span>
<span class="sd">        fig_coh_ph : boolean</span>
<span class="sd">            Whether or not to produce a figure showing the maximum coherence</span>
<span class="sd">            between H and Z</span>
<span class="sd">        save : :class:`~pathlib.Path` object</span>
<span class="sd">            Relative path to figures folder</span>
<span class="sd">        form : str</span>
<span class="sd">            File format (e.g., &#39;png&#39;, &#39;jpg&#39;, &#39;eps&#39;)</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        power : :class:`~obstools.atacr.classes.Power`</span>
<span class="sd">            Container for the Power spectra</span>
<span class="sd">        cross : :class:`~obstools.atacr.classes.Cross`</span>
<span class="sd">            Container for the Cross power spectra</span>
<span class="sd">        rotation : :class:`~obstools.atacr.classes.Rotation`, optional</span>
<span class="sd">            Container for the Rotated power and cross spectra</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Average spectra for good windows using default values and plot final</span>
<span class="sd">        figure</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import DayNoise</span>
<span class="sd">        &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; daynoise.QC_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; daynoise.average_daily_spectra(fig_average=True)</span>

<span class="sd">        .. figure:: ../obstools/examples/figures/Figure_3b.png</span>
<span class="sd">           :align: center</span>

<span class="sd">        Print out available attributes of DayNoise object</span>

<span class="sd">        &gt;&gt;&gt; daynoise.__dict__.keys()</span>
<span class="sd">        dict_keys([&#39;tr1&#39;, &#39;tr2&#39;, &#39;trZ&#39;, &#39;trP&#39;, &#39;window&#39;, &#39;overlap&#39;, &#39;key&#39;,</span>
<span class="sd">        &#39;dt&#39;, &#39;npts&#39;, &#39;fs&#39;, &#39;year&#39;, &#39;julday&#39;, &#39;tkey&#39;, &#39;ncomp&#39;, &#39;tf_list&#39;,</span>
<span class="sd">        &#39;QC&#39;, &#39;av&#39;, &#39;f&#39;, &#39;goodwins&#39;, &#39;power&#39;, &#39;cross&#39;, &#39;rotation&#39;])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">QC</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: processing daynoise object for &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;QC_daily_spectra using default values&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">QC_daily_spectra</span><span class="p">()</span>

        <span class="c1"># Extract good windows</span>
        <span class="n">c11</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c22</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cZZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cPP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">c11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">c22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Extract bad windows</span>
        <span class="n">bc11</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bc22</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bcZZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bcPP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bcZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bcPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bc11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">bc22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Calculate mean of all good windows if component combinations exist</span>
        <span class="n">c12</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c1Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c2Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c1P</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c2P</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cZP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">c12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
                <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">c1Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
                <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">c2Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
                <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">c1P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
                <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">c2P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
                <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cZP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span>
                <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Store as attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">Power</span><span class="p">(</span><span class="n">c11</span><span class="p">,</span> <span class="n">c22</span><span class="p">,</span> <span class="n">cZZ</span><span class="p">,</span> <span class="n">cPP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross</span> <span class="o">=</span> <span class="n">Cross</span><span class="p">(</span><span class="n">c12</span><span class="p">,</span> <span class="n">c1Z</span><span class="p">,</span> <span class="n">c1P</span><span class="p">,</span> <span class="n">c2Z</span><span class="p">,</span> <span class="n">c2P</span><span class="p">,</span> <span class="n">cZP</span><span class="p">)</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">Power</span><span class="p">(</span><span class="n">bc11</span><span class="p">,</span> <span class="n">bc22</span><span class="p">,</span> <span class="n">bcZZ</span><span class="p">,</span> <span class="n">bcPP</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fig_average</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">fig_average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;average.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">calc_rotation</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">cHH</span><span class="p">,</span> <span class="n">cHZ</span><span class="p">,</span> <span class="n">cHP</span><span class="p">,</span> <span class="n">coh</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">coh_value</span><span class="p">,</span> <span class="n">phase_value</span> <span class="o">=</span> \
                <span class="n">utils</span><span class="o">.</span><span class="n">calculate_tilt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ft1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftZ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">goodwins</span><span class="p">,</span> <span class="n">tiltfreqs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">Rotation</span><span class="p">(</span>
                <span class="n">cHH</span><span class="p">,</span> <span class="n">cHZ</span><span class="p">,</span> <span class="n">cHP</span><span class="p">,</span> <span class="n">coh</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">tilt</span><span class="p">,</span> <span class="n">coh_value</span><span class="p">,</span> <span class="n">phase_value</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fig_coh_ph</span><span class="p">:</span>
                <span class="n">plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">fig_coh_ph</span><span class="p">(</span><span class="n">coh</span><span class="p">,</span> <span class="n">ph</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>

                <span class="c1"># Save or show figure</span>
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tkey</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;coh_ph.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                    <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">Rotation</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="DayNoise.save">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.DayNoise.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to save the object to file using `~Pickle`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            File name</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Run demo through all methods</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import DayNoise</span>
<span class="sd">        &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; daynoise.QC_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; daynoise.average_daily_spectra()</span>

<span class="sd">        Save object</span>

<span class="sd">        &gt;&gt;&gt; daynoise.save(&#39;daynoise_demo.pkl&#39;)</span>

<span class="sd">        Check that it has been saved</span>

<span class="sd">        &gt;&gt;&gt; import glob</span>
<span class="sd">        &gt;&gt;&gt; glob.glob(&quot;./daynoise_demo.pkl&quot;)</span>
<span class="sd">        [&#39;./daynoise_demo.pkl&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: saving before having calculated the average &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;spectra&quot;</span><span class="p">)</span>

        <span class="c1"># Remove original traces to save disk space</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr1</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr2</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trZ</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trP</span>

        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="StaNoise">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.StaNoise">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StaNoise</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A StaNoise object contains attributes that associate</span>
<span class="sd">    three-component raw (or deconvolved) traces, metadata information</span>
<span class="sd">    and window parameters.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The object is initially a container for</span>
<span class="sd">    :class:`~obstools.atacr.classes.DayNoise` objects. Once the StaNoise</span>
<span class="sd">    object is initialized (using the method `init()` or by calling the</span>
<span class="sd">    `QC_sta_spectra()` method), each individual spectral quantity is unpacked</span>
<span class="sd">    as an object attribute and the original `DayNoise` objects are removed</span>
<span class="sd">    from memory. **DayNoise objects cannot be added or appended to the</span>
<span class="sd">    StaNoise object once this is done**.</span>
<span class="sd">    In addition, all spectral quantities associated with the</span>
<span class="sd">    original `DayNoise` objects (now stored as attributes) are discarded as</span>
<span class="sd">    the object is saved to disk and new container objects are defined and</span>
<span class="sd">    saved.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    daylist : list</span>
<span class="sd">        A list of :class:`~obstools.atacr.classes.DayNoise` objects to process</span>
<span class="sd">        and produce a station average</span>
<span class="sd">    initialized : bool</span>
<span class="sd">        Whether or not the object has been initialized - `False` unless one</span>
<span class="sd">        of the methods have been called. When `True`, the `daylist` attribute</span>
<span class="sd">        is deleted from memory</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Initialize empty object</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import StaNoise</span>
<span class="sd">    &gt;&gt;&gt; stanoise = StaNoise()</span>

<span class="sd">    Initialize with DayNoise object</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import DayNoise</span>
<span class="sd">    &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">    &gt;&gt;&gt; stanoise = StaNoise(daylist=[daynoise])</span>

<span class="sd">    Add or append DayNoise object to StaNoise</span>

<span class="sd">    &gt;&gt;&gt; stanoise = StaNoise()</span>
<span class="sd">    &gt;&gt;&gt; stanoise += daynoise</span>

<span class="sd">    &gt;&gt;&gt; stanoise = StaNoise()</span>
<span class="sd">    &gt;&gt;&gt; stanoise.append(daynoise)</span>

<span class="sd">    Import demo noise data with 4 DayNoise objects</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import StaNoise</span>
<span class="sd">    &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">    &gt;&gt;&gt; stanoise.daylist</span>
<span class="sd">    [&lt;obstools.atacr.classes.DayNoise at 0x11e3ce8d0&gt;,</span>
<span class="sd">     &lt;obstools.atacr.classes.DayNoise at 0x121c7ae10&gt;,</span>
<span class="sd">     &lt;obstools.atacr.classes.DayNoise at 0x121ca5940&gt;,</span>
<span class="sd">     &lt;obstools.atacr.classes.DayNoise at 0x121e7dd30&gt;]</span>
<span class="sd">     &gt;&gt;&gt; stanoise.initialized</span>
<span class="sd">     False</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daylist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_load_dn</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
            <span class="n">exmpl_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;obstools&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">))</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;2012.&#39;</span><span class="o">+</span><span class="n">day</span><span class="o">+</span><span class="s1">&#39;*.SAC&#39;</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">exmpl_path</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span> <span class="o">/</span> <span class="n">fn</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trZ</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trP</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mf">7200.</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;7D.M08A&#39;</span>
            <span class="k">return</span> <span class="n">DayNoise</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">trZ</span><span class="p">,</span> <span class="n">trP</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">overlap</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QC</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">daylist</span><span class="p">,</span> <span class="n">DayNoise</span><span class="p">):</span>
            <span class="n">daylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">daylist</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">daylist</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span> <span class="ow">or</span> <span class="n">daylist</span> <span class="o">==</span> <span class="s1">&#39;Demo&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uploading demo data - March 01 to 04, 2012, station &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;7D.M08A&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">_load_dn</span><span class="p">(</span><span class="s1">&#39;061&#39;</span><span class="p">),</span> <span class="n">_load_dn</span><span class="p">(</span>
                <span class="s1">&#39;062&#39;</span><span class="p">),</span> <span class="n">_load_dn</span><span class="p">(</span><span class="s1">&#39;063&#39;</span><span class="p">),</span> <span class="n">_load_dn</span><span class="p">(</span><span class="s1">&#39;064&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">daylist</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span> <span class="ow">and</span> <span class="n">daylist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">daylist</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">DayNoise</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">StaNoise</span><span class="p">([</span><span class="n">other</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">StaNoise</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="n">daylist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">daylist</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">daylist</span><span class="o">=</span><span class="n">daylist</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">List</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daynoise</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">daynoise</span><span class="p">,</span> <span class="n">DayNoise</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daynoise</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Append only supports a single DayNoise object as argument&#39;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daynoise_list</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">daynoise_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">daynoise_list</span><span class="p">:</span>
                <span class="c1"># Make sure each item in the list is a Grid object.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="n">DayNoise</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Extend only accepts a list of Daynoise objects.&#39;</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">daynoise_list</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">daynoise_list</span><span class="p">,</span> <span class="n">StaNoise</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">daynoise_list</span><span class="o">.</span><span class="n">daylist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Extend only supports a list of DayNoise objects as &#39;</span> <span class="o">+</span>\
                <span class="s1">&#39;argument.&#39;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="StaNoise.init">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.StaNoise.init">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to initialize the `StaNoise` object. This method is used to</span>
<span class="sd">        unpack the spectral quantities from the original</span>
<span class="sd">        :class:`~obstools.atacr.classes.DayNoise` objects and allow the</span>
<span class="sd">        methods to proceed. The original</span>
<span class="sd">        :class:`~obstools.atacr.classes.DayNoise` objects are deleted from</span>
<span class="sd">        memory during this process.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        If the original :class:`~obstools.atacr.classes.DayNoise` objects</span>
<span class="sd">        have not been processed using their QC and averaging methods, these</span>
<span class="sd">        will be called first before unpacking into the object attributes.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        f : :class:`~numpy.ndarray`</span>
<span class="sd">            Frequency axis for corresponding time sampling parameters</span>
<span class="sd">        nwins : int</span>
<span class="sd">            Number of good windows from the</span>
<span class="sd">            :class:`~obstools.atacr.classes.DayNoise` object</span>
<span class="sd">        key : str</span>
<span class="sd">            Station key for current object</span>
<span class="sd">        ncomp : int</span>
<span class="sd">            Number of available components (either 2, 3 or 4)</span>
<span class="sd">        tf_list : Dict</span>
<span class="sd">            Dictionary of possible transfer functions given the available</span>
<span class="sd">            components.</span>
<span class="sd">        c11 : `numpy.ndarray`</span>
<span class="sd">            Power spectra for component `H1`. Other identical attributes</span>
<span class="sd">            are available for</span>
<span class="sd">            the power, cross and rotated spectra: [11, 12, 1Z, 1P, 22, 2Z,</span>
<span class="sd">            2P, ZZ, ZP, PP, HH, HZ, HP]</span>
<span class="sd">        phi : `numpy.ndarray`</span>
<span class="sd">            Array of azimuths used in determining the tilt direction</span>
<span class="sd">        tilt : float</span>
<span class="sd">            Tilt direction from maximum coherence between rotated `H1` and</span>
<span class="sd">            `HZ` components</span>
<span class="sd">        QC : bool</span>
<span class="sd">            Whether or not the method</span>
<span class="sd">            :func:`~obstools.atacr.classes.StaNoise.QC_sta_spectra` has</span>
<span class="sd">            been called.</span>
<span class="sd">        av : bool</span>
<span class="sd">            Whether or not the method</span>
<span class="sd">            :func:`~obstools.atacr.classes.StaNoise.average_sta_spectra` has</span>
<span class="sd">            been called.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Initialize demo data</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import StaNoise</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.init()</span>

<span class="sd">        Check that `daylist` attribute has been deleted</span>

<span class="sd">        &gt;&gt;&gt; stanoise.daylist</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">        AttributeError: &#39;StaNoise&#39; object has no attribute &#39;daylist&#39;</span>
<span class="sd">        &gt;&gt;&gt; stanoise.__dict__.keys()</span>
<span class="sd">        dict_keys([&#39;initialized&#39;, &#39;c11&#39;, &#39;c22&#39;, &#39;cZZ&#39;, &#39;cPP&#39;, &#39;c12&#39;, &#39;c1Z&#39;,</span>
<span class="sd">        &#39;c1P&#39;, &#39;c2Z&#39;, &#39;c2P&#39;, &#39;cZP&#39;, &#39;cHH&#39;, &#39;cHZ&#39;, &#39;cHP&#39;, &#39;phi&#39;, &#39;tilt&#39;, &#39;f&#39;,</span>
<span class="sd">        &#39;nwins&#39;, &#39;ncomp&#39;, &#39;key&#39;, &#39;tf_list&#39;, &#39;QC&#39;, &#39;av&#39;])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First, check that the StaNoise object contains at least two</span>
        <span class="c1"># DayNoise objects</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;StaNoise requires at least two DayNoise objects to execute &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;its methods&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dn</span><span class="o">.</span><span class="n">QC</span><span class="p">:</span>
                <span class="n">dn</span><span class="o">.</span><span class="n">QC_daily_spectra</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dn</span><span class="o">.</span><span class="n">av</span><span class="p">:</span>
                <span class="n">dn</span><span class="o">.</span><span class="n">average_daily_spectra</span><span class="p">()</span>

        <span class="c1"># Then unpack the DayNoise objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">c11</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">c22</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cZZ</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cPP</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c12</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c1Z</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c1P</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c2Z</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c2P</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">cZP</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">cHH</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">cHZ</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">cHP</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">phi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">tilt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dn</span><span class="o">.</span><span class="n">goodwins</span><span class="p">)</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">dn</span><span class="o">.</span><span class="n">ncomp</span> <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">key</span>

        <span class="c1"># Build list of available transfer functions for future use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QC</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Remove DayNoise objects from memory</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">daylist</span></div>


<div class="viewcode-block" id="StaNoise.QC_sta_spectra">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.StaNoise.QC_sta_spectra">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">QC_sta_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pd</span><span class="o">=</span><span class="p">[</span><span class="mf">0.004</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">tol</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                       <span class="n">fig_QC</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to determine the days (for given time window) for which the</span>
<span class="sd">        spectra are anomalous and should be discarded in the calculation of</span>
<span class="sd">        the long-term transfer functions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pd : list</span>
<span class="sd">            Frequency corners of passband for calculating the spectra</span>
<span class="sd">        tol : float</span>
<span class="sd">            Tolerance threshold. If spectrum &gt; std*tol, window is flagged as</span>
<span class="sd">            bad</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Confidence interval for f-test</span>
<span class="sd">        fig_QC : boolean</span>
<span class="sd">            Whether or not to produce a figure showing the results of the</span>
<span class="sd">            quality control</span>
<span class="sd">        debug : boolean</span>
<span class="sd">            Whether or not to plot intermediate steps in the QC procedure for</span>
<span class="sd">            debugging</span>
<span class="sd">        save : :class:`~pathlib.Path` object</span>
<span class="sd">            Relative path to figures folder</span>
<span class="sd">        form : str</span>
<span class="sd">            File format (e.g., &#39;png&#39;, &#39;jpg&#39;, &#39;eps&#39;)</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        gooddays : list</span>
<span class="sd">            List of booleans representing whether a day is good (True) or not</span>
<span class="sd">            (False)</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Import demo data, call method and generate final figure</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import StaNoise</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC_sta_spectra(fig_QC=True)</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC</span>
<span class="sd">        True</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Object has been initialized already - &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;list of DayNoise objects has been lost and &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;method cannot proceed&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="c1"># Select bandpass frequencies</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Extract only positive frequencies</span>
        <span class="n">faxis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Smooth out the log of the PSDs</span>
        <span class="n">sl_cZZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sl_c11</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sl_c22</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sl_cPP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sl_cZZ</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">sl_cPP</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">sl_c11</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sl_c22</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Remove mean of the log PSDs</span>
        <span class="n">dsl_cZZ</span> <span class="o">=</span> <span class="n">sl_cZZ</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_cZZ</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dsl_cPP</span> <span class="o">=</span> <span class="n">sl_cPP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_cPP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsl_cZZ</span><span class="p">,</span> <span class="n">dsl_cPP</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dsl_c11</span> <span class="o">=</span> <span class="n">sl_c11</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_c11</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsl_c22</span> <span class="o">=</span> <span class="n">sl_c22</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_c22</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsl_c11</span><span class="p">,</span> <span class="n">dsl_c22</span><span class="p">,</span> <span class="n">dsl_cZZ</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dsl_c11</span> <span class="o">=</span> <span class="n">sl_c11</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_c11</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsl_c22</span> <span class="o">=</span> <span class="n">sl_c22</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_c22</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsl_cPP</span> <span class="o">=</span> <span class="n">sl_cPP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sl_cPP</span><span class="p">[</span><span class="n">ff</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dsls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsl_c11</span><span class="p">,</span> <span class="n">dsl_c22</span><span class="p">,</span> <span class="n">dsl_cZZ</span><span class="p">,</span> <span class="n">dsl_cPP</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_cZZ</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_cPP</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_c11</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_c22</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_cZZ</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_c11</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_c22</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_cZZ</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="n">sl_cPP</span><span class="p">[</span><span class="n">faxis</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Cycle through to kill high-std-norm windows</span>
        <span class="n">moveon</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gooddays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="kc">True</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">indwin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">gooddays</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">moveon</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ubernorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gooddays</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">ind_u</span><span class="p">,</span> <span class="n">dsl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsls</span><span class="p">):</span>
                <span class="n">normvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gooddays</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indwin</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">indwin</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span>
                    <span class="n">normvar</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dsl</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">ubernorm</span><span class="p">[</span><span class="n">ind_u</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">normvar</span><span class="p">)</span> <span class="o">-</span> <span class="n">normvar</span>

            <span class="n">penalty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ubernorm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gooddays</span><span class="p">)),</span> <span class="n">detrend</span><span class="p">(</span>
                    <span class="n">ubernorm</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gooddays</span><span class="p">)),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ubernorm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;o-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

            <span class="n">kill</span> <span class="o">=</span> <span class="n">penalty</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">penalty</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kill</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span> <span class="o">=</span> <span class="n">gooddays</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">QC</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">moveon</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">trypenalty</span> <span class="o">=</span> <span class="n">penalty</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">kill</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">ftest</span><span class="p">(</span><span class="n">penalty</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">trypenalty</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
                <span class="n">gooddays</span><span class="p">[</span><span class="n">indwin</span><span class="p">[</span><span class="n">kill</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">indwin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">gooddays</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">moveon</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">moveon</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span> <span class="o">=</span> <span class="n">gooddays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QC</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">fig_QC</span><span class="p">:</span>
            <span class="n">power</span> <span class="o">=</span> <span class="n">Power</span><span class="p">(</span><span class="n">sl_c11</span><span class="p">,</span> <span class="n">sl_c22</span><span class="p">,</span> <span class="n">sl_cZZ</span><span class="p">,</span> <span class="n">sl_cPP</span><span class="p">)</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">fig_QC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">gooddays</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;QC.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="StaNoise.average_sta_spectra">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.StaNoise.average_sta_spectra">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">average_sta_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to average the daily station spectra for good windows.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fig_average : boolean</span>
<span class="sd">            Whether or not to produce a figure showing the average daily</span>
<span class="sd">            spectra</span>
<span class="sd">        save : :class:`~pathlib.Path` object</span>
<span class="sd">            Relative path to figures folder</span>
<span class="sd">        form : str</span>
<span class="sd">            File format (e.g., &#39;png&#39;, &#39;jpg&#39;, &#39;eps&#39;)</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        power : :class:`~obstools.atacr.classes.Power`</span>
<span class="sd">            Container for the Power spectra</span>
<span class="sd">        cross : :class:`~obstools.atacr.classes.Cross`</span>
<span class="sd">            Container for the Cross power spectra</span>
<span class="sd">        rotation : :class:`~obstools.atacr.classes.Cross`, optional</span>
<span class="sd">            Container for the Rotated power and cross spectra</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Average daily spectra for good days using default values and produce</span>
<span class="sd">        final figure</span>

<span class="sd">        &gt;&gt;&gt; obstools.atacr import StaNoise</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; stanoise.average_sta_spectra()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">QC</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning: processing stanoise object for QC_sta_spectra &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;using default values&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">QC_sta_spectra</span><span class="p">()</span>

        <span class="c1"># Power spectra</span>
        <span class="n">c11</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c22</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cZZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cPP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">c11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="n">c22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>

        <span class="c1"># Bad days - for plotting</span>
        <span class="n">bc11</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bc22</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bcZZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bcPP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bcZZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span><span class="p">[:,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bcPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="p">[:,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bc11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">[:,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
                <span class="n">bc22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="p">[:,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>

        <span class="c1"># Cross spectra</span>
        <span class="n">c12</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c1Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c2Z</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c1P</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c2P</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cZP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">c12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c12</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="n">c1Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="n">c2Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">c1P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1P</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="n">c2P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2P</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cZP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cZP</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>

        <span class="c1"># Rotated component</span>
        <span class="n">cHH</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cHZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cHP</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cHH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cHH</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
            <span class="n">cHZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cHP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cHP</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">],</span>
                         <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">Power</span><span class="p">(</span><span class="n">c11</span><span class="p">,</span> <span class="n">c22</span><span class="p">,</span> <span class="n">cZZ</span><span class="p">,</span> <span class="n">cPP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross</span> <span class="o">=</span> <span class="n">Cross</span><span class="p">(</span><span class="n">c12</span><span class="p">,</span> <span class="n">c1Z</span><span class="p">,</span> <span class="n">c1P</span><span class="p">,</span> <span class="n">c2Z</span><span class="p">,</span> <span class="n">c2P</span><span class="p">,</span> <span class="n">cZP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">Rotation</span><span class="p">(</span><span class="n">cHH</span><span class="p">,</span> <span class="n">cHZ</span><span class="p">,</span> <span class="n">cHP</span><span class="p">)</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">Power</span><span class="p">(</span><span class="n">bc11</span><span class="p">,</span> <span class="n">bc22</span><span class="p">,</span> <span class="n">bcZZ</span><span class="p">,</span> <span class="n">bcPP</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fig_average</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="n">plotting</span><span class="o">.</span><span class="n">fig_average</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">power</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gooddays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="s1">&#39;average.&#39;</span> <span class="o">+</span> <span class="n">form</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">save</span> <span class="o">/</span> <span class="n">fname</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">av</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="StaNoise.save">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.StaNoise.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to save the object to file using `~Pickle`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            File name</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Run demo through all methods</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import StaNoise</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; stanoise.average_sta_spectra()</span>

<span class="sd">        Save object</span>

<span class="sd">        &gt;&gt;&gt; stanoise.save(&#39;stanoise_demo.pkl&#39;)</span>

<span class="sd">        Check that it has been saved</span>

<span class="sd">        &gt;&gt;&gt; import glob</span>
<span class="sd">        &gt;&gt;&gt; glob.glob(&quot;./stanoise_demo.pkl&quot;)</span>
<span class="sd">        [&#39;./stanoise_demo.pkl&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">av</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: saving before having calculated the average &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;spectra&quot;</span><span class="p">)</span>

        <span class="c1"># Remove traces to save disk space</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c11</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c22</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c12</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1P</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2P</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span>

        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TFNoise">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.TFNoise">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TFNoise</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A TFNoise object contains attributes that store the transfer function</span>
<span class="sd">    information from multiple components (and component combinations).</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The object is initialized with either a processed</span>
<span class="sd">    :class:`~obstools.atacr.classes.DayNoise` or</span>
<span class="sd">    :class:`~obstools.atacr.classes.StaNoise` object. Each individual</span>
<span class="sd">    spectral quantity is unpacked as an object attribute, but all of them</span>
<span class="sd">    are discarded as the object is saved to disk and new container objects</span>
<span class="sd">    are defined and saved.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    f : :class:`~numpy.ndarray`</span>
<span class="sd">        Frequency axis for corresponding time sampling parameters</span>
<span class="sd">    c11 : `numpy.ndarray`</span>
<span class="sd">        Power spectra for component `H1`. Other identical attributes are</span>
<span class="sd">        available for the power, cross and rotated spectra:</span>
<span class="sd">        [11, 12, 1Z, 1P, 22, 2Z, 2P, ZZ, ZP, PP, HH, HZ, HP]</span>
<span class="sd">    tilt : float</span>
<span class="sd">        Tilt direction from maximum coherence between rotated `H1` and</span>
<span class="sd">        `HZ` components</span>
<span class="sd">    tf_list : Dict</span>
<span class="sd">        Dictionary of possible transfer functions given the available</span>
<span class="sd">        components.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Initialize a TFNoise object with a DayNoise object. The DayNoise</span>
<span class="sd">    object must be processed for QC and averaging, otherwise the TFNoise</span>
<span class="sd">    object will not initialize.</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import DayNoise, TFNoise</span>
<span class="sd">    &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">    &gt;&gt;&gt; tfnoise = TFNoise(daynoise)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">      File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">      File &quot;/Users/pascalaudet/Softwares/Python/Projects/dev/OBStools/obstools/atacr/classes.py&quot;, line 1215, in __init__</span>
<span class="sd">    Exception: Error: Noise object has not been processed (QC and averaging) - aborting</span>

<span class="sd">    Now re-initialized with a processed DayNoise object</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import DayNoise, TFNoise</span>
<span class="sd">    &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">    &gt;&gt;&gt; daynoise.QC_daily_spectra()</span>
<span class="sd">    &gt;&gt;&gt; daynoise.average_daily_spectra()</span>
<span class="sd">    &gt;&gt;&gt; tfnoise = TFNoise(daynoise)</span>

<span class="sd">    Initialize a TFNoise object with a processed StaNoise object</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import StaNoise, TFNoise</span>
<span class="sd">    &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">    &gt;&gt;&gt; stanoise.QC_sta_spectra()</span>
<span class="sd">    &gt;&gt;&gt; stanoise.average_sta_spectra()</span>
<span class="sd">    &gt;&gt;&gt; tfnoise = TFNoise(stanoise)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objnoise</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">objnoise</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objnoise</span><span class="p">,</span> <span class="n">DayNoise</span><span class="p">)</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">objnoise</span><span class="p">,</span> <span class="n">StaNoise</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error: A TFNoise object must be initialized with only &quot;</span> <span class="o">+</span>\
                <span class="s2">&quot;one of type DayNoise or StaNoise object&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">av</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Error: Noise object has not been processed (QC and &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;averaging) - aborting&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c11</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">c11</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c22</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">c22</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cZZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cPP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHH</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">cHH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">cHZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cHP</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">cHP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c12</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c1Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1P</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c1P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c2Z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2P</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">c2P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">cZP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">tilt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span> <span class="o">=</span> <span class="n">objnoise</span><span class="o">.</span><span class="n">tf_list</span>

<div class="viewcode-block" id="TFNoise.TfDict">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.TFNoise.TfDict">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">TfDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="TFNoise.transfer_func">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.TFNoise.transfer_func">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transfer_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to calculate transfer functions between multiple</span>
<span class="sd">        components (and component combinations) from the averaged</span>
<span class="sd">        (daily or station-averaged) noise spectra.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        transfunc : :class:`~obstools.atacr.classes.TFNoise.TfDict`</span>
<span class="sd">            Container Dictionary for all possible transfer functions</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Calculate transfer functions for a DayNoise object</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import DayNoise, TFNoise</span>
<span class="sd">        &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; daynoise.QC_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; daynoise.average_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise = TFNoise(daynoise)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise.transfer_func()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise.transfunc.keys()</span>
<span class="sd">        dict_keys([&#39;ZP&#39;, &#39;Z1&#39;, &#39;Z2-1&#39;, &#39;ZP-21&#39;, &#39;ZH&#39;, &#39;ZP-H&#39;])</span>

<span class="sd">        Calculate transfer functions for a StaNoise object</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import StaNoise, TFNoise</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; stanoise.average_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise = TFNoise(stanoise)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise.transfer_func()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise.transfunc.keys()</span>
<span class="sd">        dict_keys([&#39;ZP&#39;, &#39;Z1&#39;, &#39;Z2-1&#39;, &#39;ZP-21&#39;])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">transfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TfDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZP&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">tf_ZP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TF_ZP&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="p">}</span>
                    <span class="n">transfunc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZP&#39;</span><span class="p">,</span> <span class="n">tf_ZP</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">tf_Z1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TF_Z1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">}</span>
                    <span class="n">transfunc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Z1&#39;</span><span class="p">,</span> <span class="n">tf_Z1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">lc1c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c12</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span>
                    <span class="n">coh_12</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">coherence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="p">)</span>
                    <span class="n">gc2c2_c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">coh_12</span><span class="p">)</span>
                    <span class="n">gc2cZ_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">lc1c2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span><span class="p">)</span>
                    <span class="n">lc2cZ_c1</span> <span class="o">=</span> <span class="n">gc2cZ_c1</span><span class="o">/</span><span class="n">gc2c2_c1</span>
                    <span class="n">tf_Z2_1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TF_21&#39;</span><span class="p">:</span> <span class="n">lc1c2</span><span class="p">,</span> <span class="s1">&#39;TF_Z2-1&#39;</span><span class="p">:</span> <span class="n">lc2cZ_c1</span><span class="p">}</span>
                    <span class="n">transfunc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Z2-1&#39;</span><span class="p">,</span> <span class="n">tf_Z2_1</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">lc1cZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span>
                    <span class="n">lc1c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c12</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span>
                    <span class="n">lc1cP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1P</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">c11</span>

                    <span class="n">coh_12</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">coherence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c12</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="p">)</span>
                    <span class="n">coh_1P</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">coherence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c1P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c11</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="p">)</span>

                    <span class="n">gc2c2_c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c22</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">coh_12</span><span class="p">)</span>
                    <span class="n">gcPcP_c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">coh_1P</span><span class="p">)</span>

                    <span class="n">gc2cZ_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">lc1c2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span><span class="p">)</span>
                    <span class="n">gcPcZ_c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">lc1cP</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span><span class="p">)</span>

                    <span class="n">gc2cP_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c2P</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">lc1c2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">c1P</span><span class="p">)</span>

                    <span class="n">lc2cP_c1</span> <span class="o">=</span> <span class="n">gc2cP_c1</span><span class="o">/</span><span class="n">gc2c2_c1</span>
                    <span class="n">lc2cZ_c1</span> <span class="o">=</span> <span class="n">gc2cZ_c1</span><span class="o">/</span><span class="n">gc2c2_c1</span>

                    <span class="n">coh_c2cP_c1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">coherence</span><span class="p">(</span><span class="n">gc2cP_c1</span><span class="p">,</span> <span class="n">gc2c2_c1</span><span class="p">,</span>
                                                  <span class="n">gcPcP_c1</span><span class="p">)</span>

                    <span class="n">gcPcP_c1c2</span> <span class="o">=</span> <span class="n">gcPcP_c1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">coh_c2cP_c1</span><span class="p">)</span>
                    <span class="n">gcPcZ_c1c2</span> <span class="o">=</span> <span class="n">gcPcZ_c1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">lc2cP_c1</span><span class="p">)</span><span class="o">*</span><span class="n">gc2cZ_c1</span>

                    <span class="n">lcPcZ_c2c1</span> <span class="o">=</span> <span class="n">gcPcZ_c1c2</span><span class="o">/</span><span class="n">gcPcP_c1c2</span>

                    <span class="n">tf_ZP_21</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TF_Z1&#39;</span><span class="p">:</span> <span class="n">lc1cZ</span><span class="p">,</span> <span class="s1">&#39;TF_21&#39;</span><span class="p">:</span> <span class="n">lc1c2</span><span class="p">,</span>
                                <span class="s1">&#39;TF_P1&#39;</span><span class="p">:</span> <span class="n">lc1cP</span><span class="p">,</span> <span class="s1">&#39;TF_P2-1&#39;</span><span class="p">:</span> <span class="n">lc2cP_c1</span><span class="p">,</span>
                                <span class="s1">&#39;TF_Z2-1&#39;</span><span class="p">:</span> <span class="n">lc2cZ_c1</span><span class="p">,</span> <span class="s1">&#39;TF_ZP-21&#39;</span><span class="p">:</span> <span class="n">lcPcZ_c2c1</span><span class="p">}</span>
                    <span class="n">transfunc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZP-21&#39;</span><span class="p">,</span> <span class="n">tf_ZP_21</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">tf_ZH</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TF_ZH&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cHH</span><span class="p">}</span>
                    <span class="n">transfunc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZH&#39;</span><span class="p">,</span> <span class="n">tf_ZH</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">lcHcP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cHP</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">cHH</span>
                    <span class="n">coh_HP</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">coherence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cHP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cHH</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="p">)</span>
                    <span class="n">gcPcP_cH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">coh_HP</span><span class="p">)</span>
                    <span class="n">gcPcZ_cH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">lcHcP</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span><span class="p">)</span>
                    <span class="n">lcPcZ_cH</span> <span class="o">=</span> <span class="n">gcPcZ_cH</span><span class="o">/</span><span class="n">gcPcP_cH</span>
                    <span class="n">tf_ZP_H</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TF_PH&#39;</span><span class="p">:</span> <span class="n">lcHcP</span><span class="p">,</span> <span class="s1">&#39;TF_ZP-H&#39;</span><span class="p">:</span> <span class="n">lcPcZ_cH</span><span class="p">}</span>
                    <span class="n">transfunc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZP-H&#39;</span><span class="p">,</span> <span class="n">tf_ZP_H</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Incorrect key&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">transfunc</span> <span class="o">=</span> <span class="n">transfunc</span></div>


<div class="viewcode-block" id="TFNoise.save">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.TFNoise.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to save the object to file using `~Pickle`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            File name</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Run demo through all methods</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import DayNoise, StaNoise, TFNoise</span>
<span class="sd">        &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; daynoise.QC_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; daynoise.average_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_day = TFNoise(daynoise)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_day.transfer_func()</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; stanoise.average_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_sta = TFNoise(stanoise)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_sta.transfer_func()</span>

<span class="sd">        Save object</span>

<span class="sd">        &gt;&gt;&gt; tfnoise_day.save(&#39;tf_daynoise_demo.pkl&#39;)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_sta.save(&#39;tf_stanoise_demo.pkl&#39;)</span>

<span class="sd">        Check that everything has been saved</span>

<span class="sd">        &gt;&gt;&gt; import glob</span>
<span class="sd">        &gt;&gt;&gt; glob.glob(&quot;./tf_daynoise_demo.pkl&quot;)</span>
<span class="sd">        [&#39;./tf_daynoise_demo.pkl&#39;]</span>
<span class="sd">        &gt;&gt;&gt; glob.glob(&quot;./tf_stanoise_demo.pkl&quot;)</span>
<span class="sd">        [&#39;./tf_stanoise_demo.pkl&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfunc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: saving before having calculated the transfer &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;functions&quot;</span><span class="p">)</span>

        <span class="c1"># Remove traces to save disk space</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c11</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c22</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZZ</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cPP</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cHH</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cHZ</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cHP</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c12</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1Z</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c1P</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2Z</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">c2P</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cZP</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="EventStream">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.EventStream">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EventStream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An EventStream object contains attributes that store station-event</span>
<span class="sd">    metadata and methods for applying the transfer functions to the various</span>
<span class="sd">    components and produce corrected/cleaned vertical components.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The object is initialized with :class:`~obspy.core.Trace` objects for</span>
<span class="sd">    H1, H2, HZ and P components. Traces can be empty if data are not</span>
<span class="sd">    available. Based on the available components, a list of</span>
<span class="sd">    possible corrections is determined automatically.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    tr1, tr2, trZ, trP : :class:`~obspy.core.Trace` object</span>
<span class="sd">        Corresponding trace objects for components H1, H2, HZ and HP.</span>
<span class="sd">        Traces can be empty (i.e., ``Trace()``) for missing components.</span>
<span class="sd">    key : str</span>
<span class="sd">        Station key for current object</span>
<span class="sd">    evtime : :class:`~obspy.core.UTCDateTime`</span>
<span class="sd">        Origin time of seismic event.</span>
<span class="sd">    tstamp : str</span>
<span class="sd">        Time stamp for event</span>
<span class="sd">    prefix : str</span>
<span class="sd">        Associated prefix of SAC files</span>
<span class="sd">    npts : int</span>
<span class="sd">        Number of points in time series.</span>
<span class="sd">    fs : float</span>
<span class="sd">        Sampling frequency (in Hz).</span>
<span class="sd">    dt : float</span>
<span class="sd">        Sampling distance in seconds.</span>
<span class="sd">    ncomp : int</span>
<span class="sd">        Number of available components (either 2, 3 or 4). Obtained from</span>
<span class="sd">        non-empty ``Trace`` objects</span>
<span class="sd">    ev_list : Dict</span>
<span class="sd">        Dictionary of possible transfer functions given the available</span>
<span class="sd">        components. This is determined during initialization.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    Get demo earthquake data as EventStream object</span>

<span class="sd">    &gt;&gt;&gt; from obstools.atacr import EventStream</span>
<span class="sd">    &gt;&gt;&gt; evstream = EventStream(&#39;demo&#39;)</span>
<span class="sd">    Uploading demo earthquake data - March 09, 2012, station 7D.M08A</span>
<span class="sd">    &gt;&gt;&gt; evstream.__dict__.keys()</span>
<span class="sd">    dict_keys([&#39;tr1&#39;, &#39;tr2&#39;, &#39;trZ&#39;, &#39;trP, &#39;key&#39;, &#39;evtime&#39;,</span>
<span class="sd">    &#39;tstamp&#39;, &#39;prefix&#39;, &#39;npts&#39;, fs&#39;, &#39;dt&#39;, &#39;ncomp&#39;, &#39;ev_list&#39;])</span>

<span class="sd">    Plot the raw traces</span>

<span class="sd">    &gt;&gt;&gt; import obstools.atacr.plotting as atplot</span>
<span class="sd">    &gt;&gt;&gt; figure = atplot.fig_event_raw(evstream, fmin=1./150., fmax=2.)</span>
<span class="sd">    &gt;&gt;&gt; figure.show()</span>

<span class="sd">    .. figure:: ../obstools/examples/figures/Figure_11.png</span>
<span class="sd">       :align: center</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tr1</span><span class="o">=</span><span class="n">Trace</span><span class="p">(),</span> <span class="n">tr2</span><span class="o">=</span><span class="n">Trace</span><span class="p">(),</span> <span class="n">trZ</span><span class="o">=</span><span class="n">Trace</span><span class="p">(),</span> <span class="n">trP</span><span class="o">=</span><span class="n">Trace</span><span class="p">(),</span>
        <span class="n">correct</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">tr1</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Uploading demo earthquake data - March 09, 2012, &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;station 7D.M08A&quot;</span><span class="p">)</span>
            <span class="n">exmpl_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resource_filename</span><span class="p">(</span><span class="s1">&#39;obstools&#39;</span><span class="p">,</span> <span class="s1">&#39;examples&#39;</span><span class="p">))</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">exmpl_path</span> <span class="o">/</span> <span class="s1">&#39;event&#39;</span> <span class="o">/</span> <span class="s1">&#39;2012.069*.SAC&#39;</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;2&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trZ</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trP</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tr1</span><span class="p">,</span> <span class="n">tr2</span><span class="p">,</span> <span class="n">trZ</span><span class="p">,</span> <span class="n">trP</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">ncomp</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">trZ</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Incorrect initialization of EventStream object: &quot;</span> <span class="o">+</span>
                <span class="s2">&quot;missing a vertical component or too few components&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tr1</span> <span class="o">=</span> <span class="n">tr1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr2</span> <span class="o">=</span> <span class="n">tr2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trZ</span> <span class="o">=</span> <span class="n">trZ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trP</span> <span class="o">=</span> <span class="n">trP</span>

        <span class="n">zstats</span> <span class="o">=</span> <span class="n">trZ</span><span class="o">.</span><span class="n">stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">network</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">zstats</span><span class="o">.</span><span class="n">station</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evtime</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="c1"># Time stamp</span>
        <span class="n">tstamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evtime</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> \
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evtime</span><span class="o">.</span><span class="n">julday</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span>
        <span class="n">tstamp</span> <span class="o">=</span> <span class="n">tstamp</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evtime</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evtime</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstamp</span> <span class="o">=</span> <span class="n">tstamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">npts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">sampling_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">zstats</span><span class="o">.</span><span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="n">ncomp</span>

        <span class="c1"># Build list of available transfer functions for future use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ZP&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Z2-1&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="s1">&#39;ZP-21&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZH&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ZP-H&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<div class="viewcode-block" id="EventStream.CorrectDict">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.EventStream.CorrectDict">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">CorrectDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="EventStream.correct_data">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.EventStream.correct_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">correct_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfnoise</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to apply transfer functions between multiple components (and</span>
<span class="sd">        component combinations) to produce corrected/cleaned vertical</span>
<span class="sd">        components.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tfnoise : :class:`~obstools.atacr.classes.TFNoise`</span>
<span class="sd">            Object that contains the noise transfer functions used in the</span>
<span class="sd">            correction</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        correct : :class:`~obstools.atacr.classes.EventStream.CorrectDict`</span>
<span class="sd">            Container Dictionary for all possible corrections from the</span>
<span class="sd">            transfer functions</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Let&#39;s carry through the correction of the vertical component for a</span>
<span class="sd">        single day of noise, say corresponding to the noise recorded on March</span>
<span class="sd">        04, 2012. In practice, the DayNoise object should correspond to the</span>
<span class="sd">        same day at that of the recorded earthquake to avoid bias in the</span>
<span class="sd">        correction.</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import DayNoise, TFNoise, EventStream</span>
<span class="sd">        &gt;&gt;&gt; daynoise = DayNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; daynoise.QC_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; daynoise.average_daily_spectra()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_day = TFNoise(daynoise)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_day.transfer_func()</span>
<span class="sd">        &gt;&gt;&gt; evstream = EventStream(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo earthquake data - March 09, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; evstream.correct_data(tfnoise_day)</span>

<span class="sd">        Plot the corrected traces</span>

<span class="sd">        &gt;&gt;&gt; import obstools.atacr.plotting as atplot</span>
<span class="sd">        &gt;&gt;&gt; figure = atplot.fig_event_corrected(evstream, tfnoise_day.tf_list)</span>
<span class="sd">        &gt;&gt;&gt; figure.show()</span>

<span class="sd">        .. figure:: ../obstools/examples/figures/Figure_corrected_march04.png</span>
<span class="sd">           :align: center</span>

<span class="sd">        Carry out the same exercise but this time using a StaNoise object</span>

<span class="sd">        &gt;&gt;&gt; from obstools.atacr import StaNoise, TFNoise, EventStream</span>
<span class="sd">        &gt;&gt;&gt; stanoise = StaNoise(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo data - March 01 to 04, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; stanoise.QC_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; stanoise.average_sta_spectra()</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_sta = TFNoise(stanoise)</span>
<span class="sd">        &gt;&gt;&gt; tfnoise_sta.transfer_func()</span>
<span class="sd">        &gt;&gt;&gt; evstream = EventStream(&#39;demo&#39;)</span>
<span class="sd">        Uploading demo earthquake data - March 09, 2012, station 7D.M08A</span>
<span class="sd">        &gt;&gt;&gt; evstream.correct_data(tfnoise_sta)</span>

<span class="sd">        Plot the corrected traces</span>

<span class="sd">        &gt;&gt;&gt; import obstools.atacr.plot as plot</span>
<span class="sd">        &gt;&gt;&gt; plot.fig_event_corrected(evstream, tfnoise_sta.tf_list)</span>

<span class="sd">        .. figure:: ../obstools/examples/figures/Figure_corrected_sta.png</span>
<span class="sd">           :align: center</span>


<span class="sd">        .. warning::</span>
<span class="sd">            If the noise window and event window are not identical, they cannot</span>
<span class="sd">            be compared on the same frequency axis and the code will exit. Make</span>
<span class="sd">            sure you are using identical time samples in both the noise and</span>
<span class="sd">            event windows.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">transfunc</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span>
                <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error: Object TFNoise has no transfunc &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;attribute - aborting&quot;</span><span class="p">))</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CorrectDict</span><span class="p">()</span>

        <span class="c1"># Extract list and transfer functions available</span>
        <span class="n">tf_list</span> <span class="o">=</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">tf_list</span>
        <span class="n">transfunc</span> <span class="o">=</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">transfunc</span>

        <span class="c1"># Extract traces</span>
        <span class="n">trZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trZ</span>
        <span class="n">tr1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr1</span>
        <span class="n">tr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr2</span>
        <span class="n">trP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trP</span>

        <span class="c1"># Get Fourier spectra</span>
        <span class="n">ft1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ft2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ftZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ftP</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ft1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ft2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ftZ</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ftP</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ftZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">trZ</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">ftP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">trP</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">ft1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">tr1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>
            <span class="n">ft2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">tr2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">f</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span>
                <span class="s1">&#39;Frequency axes are different: &#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">f</span><span class="p">,</span>
                <span class="s1">&#39; - the noise and event windows are not the same, aborting&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tf_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZP&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">tf_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">TF_ZP</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_ZP&#39;</span><span class="p">]</span>
                    <span class="n">corrspec</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">-</span> <span class="n">TF_ZP</span><span class="o">*</span><span class="n">ftP</span>
                    <span class="n">corrtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">corrspec</span><span class="p">))</span>
                    <span class="n">correct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZP&#39;</span><span class="p">,</span> <span class="n">corrtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Z1&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">tf_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">TF_Z1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_Z1&#39;</span><span class="p">]</span>
                    <span class="n">corrspec</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">-</span> <span class="n">TF_Z1</span><span class="o">*</span><span class="n">ft1</span>
                    <span class="n">corrtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">corrspec</span><span class="p">))</span>
                    <span class="n">correct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Z1&#39;</span><span class="p">,</span> <span class="n">corrtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Z2-1&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">tf_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">TF_Z1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="s1">&#39;Z1&#39;</span><span class="p">][</span><span class="s1">&#39;TF_Z1&#39;</span><span class="p">]</span>
                    <span class="n">TF_21</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_21&#39;</span><span class="p">]</span>
                    <span class="n">TF_Z2_1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_Z2-1&#39;</span><span class="p">]</span>
                    <span class="n">corrspec</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">-</span> <span class="n">TF_Z1</span><span class="o">*</span><span class="n">ft1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ft2</span> <span class="o">-</span> <span class="n">ft1</span><span class="o">*</span><span class="n">TF_21</span><span class="p">)</span><span class="o">*</span><span class="n">TF_Z2_1</span>
                    <span class="n">corrtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">corrspec</span><span class="p">))</span>
                    <span class="n">correct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Z2-1&#39;</span><span class="p">,</span> <span class="n">corrtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZP-21&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">tf_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">TF_Z1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_Z1&#39;</span><span class="p">]</span>
                    <span class="n">TF_21</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_21&#39;</span><span class="p">]</span>
                    <span class="n">TF_Z2_1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_Z2-1&#39;</span><span class="p">]</span>
                    <span class="n">TF_P1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_P1&#39;</span><span class="p">]</span>
                    <span class="n">TF_P2_1</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_P2-1&#39;</span><span class="p">]</span>
                    <span class="n">TF_ZP_21</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_ZP-21&#39;</span><span class="p">]</span>
                    <span class="n">corrspec</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">-</span> <span class="n">TF_Z1</span><span class="o">*</span><span class="n">ft1</span> <span class="o">-</span> \
                        <span class="p">(</span><span class="n">ft2</span> <span class="o">-</span> <span class="n">ft1</span><span class="o">*</span><span class="n">TF_21</span><span class="p">)</span><span class="o">*</span><span class="n">TF_Z2_1</span> <span class="o">-</span> \
                        <span class="p">(</span><span class="n">ftP</span> <span class="o">-</span> <span class="n">ft1</span><span class="o">*</span><span class="n">TF_P1</span> <span class="o">-</span>
                         <span class="p">(</span><span class="n">ft2</span> <span class="o">-</span> <span class="n">ft1</span><span class="o">*</span><span class="n">TF_21</span><span class="p">)</span><span class="o">*</span><span class="n">TF_P2_1</span><span class="p">)</span><span class="o">*</span><span class="n">TF_ZP_21</span>
                    <span class="n">corrtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">corrspec</span><span class="p">))</span>
                    <span class="n">correct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZP-21&#39;</span><span class="p">,</span> <span class="n">corrtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZH&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">tf_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>

                    <span class="c1"># Rotate horizontals</span>
                    <span class="n">ftH</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rotate_dir</span><span class="p">(</span><span class="n">ft1</span><span class="p">,</span> <span class="n">ft2</span><span class="p">,</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">tilt</span><span class="p">)</span>

                    <span class="n">TF_ZH</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_ZH&#39;</span><span class="p">]</span>
                    <span class="n">corrspec</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">-</span> <span class="n">TF_ZH</span><span class="o">*</span><span class="n">ftH</span>
                    <span class="n">corrtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">corrspec</span><span class="p">))</span>
                    <span class="n">correct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZH&#39;</span><span class="p">,</span> <span class="n">corrtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ZP-H&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ev_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">tf_list</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>

                    <span class="c1"># Rotate horizontals</span>
                    <span class="n">ftH</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">rotate_dir</span><span class="p">(</span><span class="n">ft1</span><span class="p">,</span> <span class="n">ft2</span><span class="p">,</span> <span class="n">tfnoise</span><span class="o">.</span><span class="n">tilt</span><span class="p">)</span>

                    <span class="n">TF_ZH</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="s1">&#39;ZH&#39;</span><span class="p">][</span><span class="s1">&#39;TF_ZH&#39;</span><span class="p">]</span>
                    <span class="n">TF_PH</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_PH&#39;</span><span class="p">]</span>
                    <span class="n">TF_ZP_H</span> <span class="o">=</span> <span class="n">transfunc</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;TF_ZP-H&#39;</span><span class="p">]</span>
                    <span class="n">corrspec</span> <span class="o">=</span> <span class="n">ftZ</span> <span class="o">-</span> <span class="n">TF_ZH</span><span class="o">*</span><span class="n">ftH</span> <span class="o">-</span> <span class="p">(</span><span class="n">ftP</span> <span class="o">-</span> <span class="n">ftH</span><span class="o">*</span><span class="n">TF_PH</span><span class="p">)</span><span class="o">*</span><span class="n">TF_ZP_H</span>
                    <span class="n">corrtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">corrspec</span><span class="p">))</span>
                    <span class="n">correct</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ZP-H&#39;</span><span class="p">,</span> <span class="n">corrtime</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">correct</span> <span class="o">=</span> <span class="n">correct</span></div>


<div class="viewcode-block" id="EventStream.save">
<a class="viewcode-back" href="../../../atacr.html#obstools.atacr.classes.EventStream.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to save the object to file using `~Pickle`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            File name</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Following from the example outlined in method</span>
<span class="sd">        :func:`~obstools.atacr.classes.EventStream.correct_data`, we simply</span>
<span class="sd">        save the final object</span>

<span class="sd">        &gt;&gt;&gt; evstream.save(&#39;evstream_demo.pkl&#39;)</span>

<span class="sd">        Check that object has been saved</span>

<span class="sd">        &gt;&gt;&gt; import glob</span>
<span class="sd">        &gt;&gt;&gt; glob.glob(&quot;./evstream_demo.pkl&quot;)</span>
<span class="sd">        [&#39;./evstream_demo.pkl&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;correct&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: saving EventStream object before having done &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;the corrections&quot;</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Pascal Audet, Helen Janiszewski.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>